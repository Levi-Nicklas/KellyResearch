---
title: "Kelly Criterion"
author: "Xin Wang & Levi C. Nicklas"
output: html_notebook
---

```{r Setup, message = FALSE}
library(CVXR)
library(tidyverse)
library(reshape2)
```

# Introduction

The Kelly criterion, also known as Kelly gambling, is a formula that aims to provide the optimal size bet to make. What is particularly nice about this method, is that it is *intertemporal*, meaning it is independent of time. This means you only have to calculate it once, and then stick to the plan given that the circumstances of the game have not changed. This problem can be viewed as a convex optimization problem where the goal is to maximize the rate at which your wealth grows.

# About Kelly Gambling

Kelly Gambling has found great successes in portfolio management. In particular, it is quite popular in applications to the stock market, as the stock market can be viewed as a gambling game $^{[2]}$. This method was developed by J.L. Kelly Jr. in 1956  $^{[1]}$. (ADD MORE HERE.)

# Convex Optimization of Kelly Gambling
First we demonstrate how the Kelly gambling problem can be viewed as a convex optimization problem. 

In the case for Kelly gambling, our function we aim to maximize is the average growth rate of our wealth. 

We reproduce the result from the `CVX` paper, Example 4.6, by adapting the MatLab code to `R`.

## Find Optimal Value

```{r Define Variables}
# Initial Bankroll
w0 = 100

# Input data from CVXR Example.
P <- c(3.5000, 1.1100, 1.1100, 1.0400, 1.0100,
     0.5000, 0.9700, 0.9800, 1.0500, 1.0100,
     0.5000, 0.9900, 0.9900, 0.9900, 1.0100,
     0.5000, 1.0500, 1.0600, 0.9900, 1.0100,
     0.5000, 1.1600, 0.9900, 1.0700, 1.0100,
     0.5000, 0.9900, 0.9900, 1.0600, 1.0100,
     0.5000, 0.9200, 1.0800, 0.9900, 1.0100,
     0.5000, 1.1300, 1.1000, 0.9900, 1.0100,
     0.5000, 0.9300, 0.9500, 1.0400, 1.0100,
     3.5000, 0.9900, 0.9700, 0.9800, 1.0100)



# Reformat to Matrix
P <- matrix(P, ncol = 5, byrow = TRUE)

P <- matrix(c(1.1, -1, 1.1, -1 ,1.1, -1, 1.1 ,-1), ncol = 2, byrow = TRUE)

#P <- rnorm(100, mean = 1, sd = 0.2)
#P <- matrix(P, ncol = 5, byrow = TRUE)

# Save Matrix Dimensions
P_dim <- dim(P)

# Probabilities
ps <- rep(1, P_dim[1]) / P_dim[1]


# Proportion of Wealth Bet
b <- CVXR::Variable(P_dim[2])
```

```{r Solve Convex Problem}
constr <- list(b >= 0, sum(b) == 1)

prob <- CVXR::Problem(
  CVXR::Maximize(sum(t(ps) %*% log(P %*% b))),
  constr)

result <- solve(prob)
result$value
result$getValue(b)
```

## Simulations

```{r Simulate}
# 1 Simulation
# bets <- result$getValue(b)
# idx <- sample.int(10, size = 10, prob =  ps, replace = TRUE)
# winnings <- P[idx,] %*% bets
# wealth <- w0 * cumprod(winnings)

# Multiple Simulations
n_sim <- 50
simulations <- matrix(rep(0,20*n_sim), nrow = 20)

for(i in 1:n_sim){
  bets <- result$getValue(b)
  idx <- sample.int(20, size = 20, prob =  ps, replace = TRUE)
  winnings <- P[idx,] %*% bets
  wealth <- w0 * cumprod(winnings)
  
  simulations[,i] <- wealth
}

simulations %>% 
  melt() %>% 
  group_by(Var2) %>% 
  ggplot(aes(Var1, value, group = Var2)) +
  geom_line(color = "purple" , alpha = 0.5) +
  geom_hline(yintercept = 100, color = "black", size = 1.15, linetype = "dashed") +
  geom_vline(xintercept = 1,  color = "black", size = 1.15, linetype = "dashed")+
  labs(title = "50 Simulations of 10 Rounds of Game",
       x = "Round",
       y = "Wealth ($)") +
  theme_minimal()
  


```




# References
$^{[1]}$ : 

$^{[2]}$ : http://www.diva-portal.org/smash/get/diva2:812697/FULLTEXT01.pdf 




